<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="renderer" content="webkit">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>游戏的自动化测试 - Magic ABC</title>
    <link rel="alternate" type="application/rss+xml" href="/feed.xml" title="Magic ABC" />

    <!-- Bootstrap -->
    <!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" type="text/css" href="../static/css/bootstrap/css/bootstrap.css"/>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
      <script src="js/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="../static/css/slick.css"/>
    <link rel="stylesheet" type="text/css" href="../static/css/circle.css"/>
    <link rel="stylesheet" type="text/css" href="../static/css/otl-theme.css"/>
  </head>
  <body>


        <div class="container-fluid w960 banner">

                <div class="row w960i logo">
                    <div class="col-md-offset-1 col-sm-offset-1 col-xs-offset-2">
                      <h1>Magic ABC</h1>
                    </div>
                </div>

                <div class="row w960i banner-sign">
                  <div class="col-md-11">
                    <div class="pull-right"><p>ON THE ROAD</p><div class="underline0"></div></div>
                    <div class="clearfix"></div>
                    <div class="pull-right"><p>HUANG</p><div class="underline0"></div></div>
                  </div>
                </div>

                <div class="row">
                    <nav class="navbar col-md-offset-7 col-sm-offset-6">
                      <div class="container-fluid">
                        <div class="navbar-header">
                          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#banner-menu" aria-expanded="false">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                          </button>
                        </div>

                        <div class="collapse navbar-collapse row" id="banner-menu">
                          <div class="col-sm-offset-0 col-xs-offset-10">
                          <ul class="nav navbar-nav">
                            <li class=""><a href="../">HOME</a><div class="underline"></div></li>
                            <li class=""><a href="../page/1.html">BLOG</a><div class="underline"></div></li>
                            <li class=""><a href="#">WORK</a><div class="underline"></div></li>
                            <li class=""><a href="../about.html">ABOUT</a><div class="underline"></div></li>
                          </ul>
                          </div>
                        </div>
                      </div>
                    </nav>
                </div>
        </div>
        <div class="container-fluid w960 post">
                
                <div class="row">
                  <div class="col-sm-offset-2 col-sm-8 col-xs-offset-1 col-xs-10">
                    <h1>游戏的自动化测试</h1>
                    <div class="split-title-1"></div>

                    <div class="post">
                        <p>作为一个懒惰的程序员，要自动化一切，包括游戏测试。</p>
<p>游戏是一个复杂的CS系统，本身的数据流是二进制的，不像网页那样的文本制好解析；画面和UI是基于DX的，也就不能用一些测试通用窗口控件的工具去测试游戏。</p>
<p>我尝试过一些从各方面借鉴的做法。</p>
<p><strong>单元测试</strong></p>
<p>很多年以前，我在寻仙项目上尝试了单元测试。基本借鉴了《修改代码的艺术》一书，<a href="http://www.cppblog.com/darkdestiny/archive/2008/01/11/41001.html">对C++进行单元测试</a>。C++不同于脚本语言的动态性，mock的时候需要花费较多的精力，但进行单元测试是可行的。</p>
<p>我对服务器部分的一个组队模块部署了单元测试，但是接口和模块功能变化太频繁，很快就不再维护了。</p>
<p><strong>协议测试</strong></p>
<p>再一次的考虑自动化测试是在刀2项目。这一次依赖的是机器人工具和脚本，做了一个极简的客户端，让这个客户端可以通过脚本登陆、退出和收发所有消息，然后在脚本中定制测试流程。</p>
<p>这套工具听着蛮不错的，至少能测试服务器真实的交互流程，QA也用过一段时间，用来测压力和刷怪。但说到测试某个子模块，却一直未能成形。</p>
<p>其实还是老问题，通信协议太容易变化了。今天这个子模块还好好的，明天可能就某个协议增加了字段或者调整了发送顺序，测试就挂了。</p>
<p>这样一来，调整太频繁，可用性就低了。</p>
<p><strong>rspec</strong></p>
<p>最近在学习ruby on rails，相应的也就接触到rspec测试，很快就有了灵感，觉得这可能是一个更靠谱的方向。</p>
<p>rspec把整个页面作为测试对象，通过填充和点击操作，验证页面刷新包含的目标字符串。页面其实就是DOM文本，前面说到游戏从里到外都是二进制的，视觉内容还真不是一般工具能检测和操作的。</p>
<p>虽然如此，但是灵感就从中抽象出来。UI模块虽然是私有的二进制数据集合，但实际上对我们而言就是一棵控件树，在客户端的脚本里，同样可以用类似rspec的方式去操作UI，并且检验结果。</p>
<p>为了降低功能的频繁调整而降低测试的可用性，测试脚本一定是要把UI当做黑盒，尽可能用稳定的接口。用类似rspec的语法写个测试游戏商城模块的例子：</p>
<pre>describe &#39;mall&#39; do
    click_button ui_main.w_main, &#39;商城&#39;
    wait 2, seconds

    assert ui_supermarket.w_win.visible
    assert { have_content ui_supermarket.w_win, &#39;圣甲精华&#39; }

    click_button ui_supermarket.w_win, &#39;购买&#39;, &#39;圣甲精华&#39; }
    assert ui_msgbox.w_win.visible

    fill ui_msgbox.w_win, &#39;数量&#39;, 1
    click_button ui_msgbox.w_win, &#39;购买&#39;
    wait 2, seconds

    assert { have_item(&#39;圣甲精华&#39;, 1) }
end</pre><p>测试的流程大体是打开商城界面，点击圣甲精华购买按钮，出现购买确认对话后，填充数量并发起购买，然后确认道具数量的变化。</p>
<p>虽说把UI当黑盒，但窗口的顶层控件作为参数会有利于测试加速。比如 <em>have_content</em> 就是在商城窗口中搜索圣甲精华文字，至于这个文字到底放在哪，则一层层的去搜索商城窗口的子控件去寻找了。</p>
<p>无视UI的布局细节，尽量从客户端本身的数据中，通过不易改变的名字去查找和验证，就不惧怕程序的频繁调整了。</p>

                    </div>

                    <div class="split-1"></div>
                    <div class="time">Sunday, Apr 6th, 2014</div><div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'magicabc';
  var disqus_title = '游戏的自动化测试';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
                  </div>


                </div>
        </div>

         

        <div class="container-fluid w960 footer">
          <div class="row">
            <div class="col-md-offset-1 col-sm-2 hidden-xs">
              <span style="color:#9b9b9b">@2017 HUANG</span>
            </div>
            <div style=" text-align:center" class="col-xs-12 col-sm-8 col-md-6 center-block">
              <span>MAGIC</span>&nbsp<span style="color:#FD433E">ABC</span>
            </div>
            <div class="col-sm-2 hidden-xs">
              <a href="https://twitter.com/bjtugun" class="pull-right"><image src="../static/images/twitter.png" ></image></a>
              <a href="https://coding.net/u/hwh008" class="pull-right" style="margin-right:10px"><image src="../static/images/coding.png" ></image></a>
            </div>
          </div>

        </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
    <script type="text/javascript" src="../static/js/slick.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="../static/js/bootstrap.min.js"></script>
    <script>
      $(function(){
        if(document.getElementById('auth-info')) {
          var slick = $('#auth-info').slick({
            autoplay: true,
            prevArrow: '#auth-info-prev',
            nextArrow: '#auth-info-next'
          });
      }});      
    </script>
  </body>
</html>